"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}();!function(e,t){t.body;var a={touch:"ontouchend"in t,$:function(e,a,n){var i=n||"querySelector";return a&&a[i]?a[i](e):t[i](e)},$$:function(e,t){return this.$(e,t,"querySelectorAll")},transform:function(e,t,a,n){t=parseInt(t),a=parseInt(a),e.style.transformOrigin=e.style.webkitTransformOrigin=t+"px "+a+"px",e.style.transform=e.style.webkitTransform="translate("+-t+"px,"+-a+"px) scale("+n+")"},ondown:function(e,t){return a.touch?e.addEventListener("touchstart",t):e.addEventListener("mousedown",function(e){e.touches=[{pageX:e.pageX,pageY:e.pageY}],t.call(this,e)}),this},onmove:function(e,t){return a.touch?e.addEventListener("touchmove",t):e.addEventListener("mousemove",function(e){e.touches=[{pageX:e.pageX,pageY:e.pageY}],t.call(this,e)}),this},onup:function(e,t){return a.touch?(e.addEventListener("touchend",t),e.addEventListener("touchcancel",t)):e.addEventListener("mouseup",t),this},ontap:function(e,t){if(a.touch){var n=null,i=null,r=null,s=null;e.addEventListener("touchstart",function(e){1==e.touches.length&&(n=r=e.touches[0].pageX,i=s=e.touches[0].pageY)}),e.addEventListener("touchmove",function(e){null!=n&&(r=e.touches[0].pageX,s=e.touches[0].pageY)}),e.addEventListener("touchend",function(){Math.pow(n-r,2)+Math.pow(i-s,2)<400&&t.call(e),n=null})}else e.addEventListener("click",t);return this},extend:function(){var e,t,n,i,r,s,o=arguments,l=o[0]||{},c=1,h=o.length,u=!1;for(a.isBoolean(l)&&(u=l,l=o[c]||{},c++),a.isObject(l)||a.isFunction(l)||(l={}),c===h&&(l=this,c--);c<h;c++)if(null!=(e=o[c]))for(t in e)n=l[t],l!==(i=e[t])&&(u&&i&&(jQuery.isPlainObject(i)||(r=Array.isArray(i)))?(r?(r=!1,s=n&&Array.isArray(n)?n:[]):s=n&&jQuery.isPlainObject(n)?n:{},l[t]=jQuery.extend(u,s,i)):void 0!==i&&(l[t]=i));return l}};Array.prototype.forEach.call(["Object","Function","String","Number","Array","Boolean","File",{type:"Img",key:"HTMLImageElement"},{type:"Canvas",key:"HTMLCanvasElement"}],function(e){a["is"+(e.type||e)]=function(t){return Object.prototype.toString.call(t)==="[object "+(e.key||e)+"]"}});var n=function(){function n(e){_classCallCheck(this,n),this._initData(e)}return _createClass(n,null,[{key:"createCanvas",value:function(e,a){var n=t.createElement("canvas");return e>0&&(n.width=e),a>0&&(n.height=a),n}},{key:"loadImgToCanvas",value:function(e,t){var a=e.getContext("2d"),n=e.width=t.width,i=e.height=t.height;a.clearRect(0,0,n,i),a.drawImage(t,0,0)}},{key:"getFileUrl",value:function(t,n){if(a.isFunction(n))if(a.isFile(t)){var i;if(e.URL)try{i=URL.createObjectURL(t)}catch(e){}if(i)n(null,i);else try{var r=new FileReader;r.onload=function(){n(null,this.result)},r.onerror=n,r.readAsDataURL(t)}catch(e){n(e)}}else n()}}]),_createClass(n,[{key:"__loadingHandler",value:function(){var e=this;e.__.state.load=n.STATE.LOADING,e._showLayer("loading")}},{key:"__loadHandler",value:function(){var e=this,t=e.__;if(t.state.load=n.STATE.LOADED,e.reset(),t.state.show){var i=t.iframe.contentDocument;a.$(".js_clip_save",i).className="js_clip_save",e._hideLayer()}}},{key:"__showHandler",value:function(){var e=this,t=e.__;if(t.state.load==n.STATE.LOADING)e._showLayer("loading");else if(t.state.load!=n.STATE.LOADED)e._showLayer("empty");else{var i=t.iframe.contentDocument;a.$(".js_clip_save",i).className="js_clip_save"}}},{key:"__hideHandler",value:function(){}},{key:"__saveHandler",value:function(){}},{key:"__errorHandler",value:function(e){var t=this,a=t.__;if(!e.message)switch(e.code){case n.ERROR.LOAD_IMG_FAIL:e.message="加载图片失败";break;case n.ERROR.SAVE_IMG_FAIL:e.message="保存图片失败";break;case n.ERROR.OPEN_FILE_FAIL:e.message="读取文件失败"}a.state.error=e,t._showLayer("error",e)}},{key:"_trigger",value:function(e,t){var n=this;if(e&&a.isString(e)){var i=n["__"+e+"Handler"];i&&i.call(n,t),i=n.__.opts["on"+e.toLowerCase()],a.isFunction(i)&&i.call(n,t)}return n}},{key:"_showLayer",value:function(e,t){var n=this,i=n.__;if(i.state.show){var r,s=i.iframe.contentDocument;switch(e){case"loading":r="loading",t="正在加载中";break;case"error":r="error",t=t&&t.message||"操作失败";break;case"empty":r="file",t="选择文件"}if(r){t||(t="");var o=a.$(".js_layer",s);o.innerHTML='<div class="laver-wrap"><svg class="clip-icon"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon_'+r+'"></use></svg><span>'+t+"</span></div>",o.setAttribute("data-type",e),o.style.display=""}}return n}},{key:"_hideLayer",value:function(){var e=this,t=e.__;if(t.state.show){var n=t.iframe.contentDocument;a.$(".js_layer",n).style.display="none"}return e}},{key:"_setClipShapePath",value:function(e,t){var a=this,i=a.__,r=i.opts,s=i.view,o=e.width,l=e.height,c=e.getContext("2d"),h=Math.min(o,l),u=Math.max(0,parseInt((o-h)/2)),p=Math.max(0,parseInt((l-h)/2)),d=u+h,f=p+h;if(t){if(r.shape==n.SHAPE.RECT&&r.rectRatio>0){var v=r.rectRatio;v>1?(v=h*(v-1)/(2*v),p=parseInt(p+v),f=parseInt(f-v)):(v=h*(1-v)/2,u=parseInt(u+v),d=parseInt(d-v))}s.size=h,s.left=u,s.top=p,s.right=d,s.bottom=f}return t&&(c.save(),c.clearRect(0,0,o,l),c.fillStyle="rgba(0,0,0,.7)",c.fillRect(0,0,o,l)),c.beginPath(),r.shape==n.SHAPE.CIRCLE?c.arc(parseInt(o/2),parseInt(l/2),parseInt(h/2),0,2*Math.PI):c.rect(u,p,d-u,f-p),c.closePath(),t&&(c.clip(),c.clearRect(0,0,o,l),c.strokeStyle="#fff",c.stroke(),c.restore()),a}},{key:"_initData",value:function(e){var t=this,i=0;t.__&&t.__.state&&t.__.state.show&&(i=1,t.hide());var r={opts:{},state:{error:0,load:0,show:0},canvas:n.createCanvas(),iframe:null,content:"",width:0,height:0,view:{canvas:n.createCanvas(),width:0,height:0,size:0,btnsHeight:54,left:0,right:0,top:0,bottom:0},transform:{x:0,y:0,scale:1},random:parseInt(1e5*Math.random()),result:{type:"",quality:null,data:"",width:0,height:0}};t.__=r;for(var s in n.defaultOptions)r.opts[s]=n.defaultOptions[s];if(a.isObject(e))for(var s in e)/^on\w/.test(s)&&a.isFunction(e[s])?r.opts[s.toLowerCase()]=e[s]:r.opts[s]=e[s];return i&&t.show(),t}},{key:"_initDlg",value:function(){var i=this,r=i.__,s=(r.opts,r.view),o=r.iframe,l=r.content,c=r.transform;o||((o=t.createElement("iframe")).style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;border:0;z-index:99999",l="<style>\n                    body{margin:0;font:16px/1.5 sans-serif}\n                    a,a:hover{text-decoration:none}\n                    .clip,.layer{display:-webkit-box;display:flex;position:fixed;top:0;left:0;right:0;bottom:0;background-color:#000;}\n                    .clip{-webkit-box-orient:vertical;flex-direction:column}\n                    .clip-cont{position:relative;-webkit-box-flex:1;flex:1;overflow:hidden}\n                    .clip-cont>*{position:absolute;left:0;top:0;}\n                    .clip-btns{display:-webkit-box;display:flex;width:100%;height:"+s.btnsHeight+'px;background:rgba(255,255,255,.1)}\n                    .clip-btns>*{display:block;padding:15px 0;width:50%;font-size:16px;color:#fff;text-align:center}\n                    .clip-btns>*:first-child{opacity:.7}\n                    .clip-icon{display:inline-block;width:32px;height:32px;fill:#fff;}\n                    .layer{-webkit-box-pack:center;-webkit-box-align:center;align-items:center;background:rgba(0,0,0,.5);color:#fff;line-height:50px;}\n                    .laver-wrap{width:100%;text-align:center}\n                    .laver-wrap>*{vertical-align:middle;}\n                    .laver-wrap svg{margin-right:5px;}\n                    .disable{opacity:.4}\n                    </style>\n                    <svg style="display:none;" xmlns="http://www.w3.org/2000/svg">\n                        <defs>\n                            <symbol id="icon_loading" viewBox="0 0 50 50">\n                                <path d="M43.935,25.145c0-10.318-8.364-18.683-18.683-18.683c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615c8.072,0,14.615,6.543,14.615,14.615H43.935z">\n                                    <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"/>\n                                </path>\n                            </symbol>\n                            <symbol id="icon_error" viewBox="0 0 32 32">\n                                <path d="M18.086 20.232c0.083 0.090 0.133 0.21 0.133 0.342 0 0.279-0.226 0.505-0.505 0.505-0.154 0-0.292-0.069-0.385-0.177l-0.001 0.001c-0.003-0.004-0.006-0.008-0.009-0.013-0.007-0.009-0.014-0.018-0.021-0.028-0.52-0.688-1.346-1.132-2.275-1.132-0.898 0-1.699 0.415-2.222 1.064-0.085 0.165-0.257 0.278-0.455 0.278-0.283 0-0.511-0.229-0.511-0.512 0-0.144 0.059-0.273 0.155-0.366 0.697-0.913 1.796-1.503 3.034-1.503 1.254 0 2.367 0.606 3.062 1.541zM17.2 25.72v0h8.52c0.414 0 0.748-0.335 0.748-0.747v-17.945c0-0.414-0.335-0.747-0.748-0.747h-21.382c-0.414 0-0.748 0.335-0.748 0.747v17.945c0 0.414 0.335 0.747 0.748 0.747h8.376l1.199 1.046 1.030 0h-1.029l1.2 1.047 1.117-1.047-0.96-0h0.961l1.116-1.046h-0.146zM17.495 26.766l-1.944 1.833c-0.24 0.227-0.635 0.234-0.884 0.016l-2.104-1.848h-8.524c-0.827 0-1.497-0.668-1.497-1.495v-18.543c0-0.826 0.67-1.495 1.497-1.495h21.979c0.827 0 1.497 0.668 1.497 1.495v18.543c0 0.826-0.67 1.495-1.497 1.495h-8.522zM27.514 24.822v-1.047h0.149c0.414 0 0.748-0.335 0.748-0.747v-17.945c0-0.414-0.335-0.747-0.748-0.747h-21.382c-0.414 0-0.748 0.335-0.748 0.747v0.15h-1.047v-0.449c0-0.826 0.67-1.495 1.497-1.495h21.979c0.827 0 1.497 0.668 1.497 1.495v18.543c0 0.826-0.67 1.495-1.497 1.495h-0.447zM21.533 11.364l0.748 0.73-1.794 1.991 1.794 1.938-0.748 0.724-2.393-2.672 2.393-2.712zM8.374 11.364l2.393 2.712-2.393 2.672-0.748-0.724 1.794-1.938-1.794-1.991 0.748-0.73z"></path>\n                            </symbol>\n                            <symbol id="icon_file" viewBox="0 0 15 15">\n                                <path d="M14.969,0.031 L5,0.031 L5,2.969 L6,2.969 L6,1 L14.027,1 L14.027,8.001 L11,8.001 L11,10.952 L14.969,10.952 L14.969,0.031 Z" class="si-glyph-fill"></path>\n                                <path d="M0,4 L0,15 L10,15 L10,4 L0,4 L0,4 Z M8.967,12 L0.967,12 L0.967,5 L8.967,5 L8.967,12 L8.967,12 Z" class="si-glyph-fill"></path>\n                            </symbol>\n                        </defs>\n                    </svg>\n                    <div class="clip js_clip">\n                        <div class="clip-cont">\n                            <div class="js_clip_pic"></div>\n                            <canvas class="clip-cover js_clip_cover"></canvas>\n                            <div class="layer js_layer" style="display:none"></div>\n                        </div>\n                        <div class="clip-btns">\n                            <a class="js_clip_cancel" href="javascript:;">取消</a>\n                            <a class="js_clip_save disable" href="javascript:;">选取</a>\n                        </div>\n                    </div>',r.iframe=o,r.content=l),t.body.appendChild(o);var h=o.contentDocument;h.write(l),h.close();var u=parseInt(e.innerWidth),p=parseInt(e.innerHeight-s.btnsHeight);s.width=u,s.height=p;var d=a.$(".js_clip_cover",h);d.width=u,d.height=p,i._setClipShapePath(d,!0);var f=s.canvas;a.$(".js_clip_pic",h).appendChild(f);var v,g=0,_=function(e,t,n){var i=r.width,o=r.height,l=s.left/n,h=s.top/n,u=s.right/n,p=s.bottom/n;e=Math.min(Math.max(e,-l),i-u),t=Math.min(Math.max(t,-h),o-p),e>=-l&&e<=i-u&&t>=-h&&t<=o-p&&(c.x=e,c.y=t,c.scale=n,a.transform(f,e,t,n))};return a.ondown(d,function(e){if(r.state.show&&r.state.load==n.STATE.LOADED){g=1,v=[];for(var t=0,a=e.touches.length;t<a;t++)v.push({x:e.touches[t].pageX,y:e.touches[t].pageY})}e.preventDefault(),e.stopPropagation()}).onmove(d,function(e){if(g){r.width,r.height,s.size;var t,a,n,i,o=c.scale,l=e.touches[0].pageX,h=e.touches[0].pageY;if(2==e.touches.length&&2==v.length){n=e.touches[1].pageX,i=e.touches[1].pageY;var u=(v[0].x+v[1].x)/2,p=(v[0].y+v[1].y)/2,d=Math.sqrt(Math.pow(v[1].x-v[0].x,2)+Math.pow(v[1].y-v[0].y,2)),f=Math.sqrt(Math.pow(n-l,2)+Math.pow(i-h,2))/d,y=(f-1)/(o=c.scale*f);t=c.x+u*y,a=c.y+p*y}else t=c.x+(v[0].x-l)/o,a=c.y+(v[0].y-h)/o;_(t,a,o),v[0].x=l,v[0].y=h,2==v.length&&(v[1].x=n,v[1].y=i)}e.preventDefault(),e.stopPropagation()}).onup(d,function(){g=0}).ontap(a.$(".js_clip_cancel",h),function(){i.hide("cancel")}).ontap(a.$(".js_clip_save",h),function(){/disable/.test(this.className)||i.save()}).ontap(a.$(".js_layer",h),function(){if("empty"==this.getAttribute("data-type")){var e=a.$("#file",h);e||((e=h.createElement("input")).id="file",e.type="file",e.style.display="none",e.accept="image/*",h.body.appendChild(e),e.onchange=function(){this.files[0]&&i.load(this.files[0])}),e.click()}}),d.addEventListener("mousewheel",function(e){if(r.state.show&&r.state.load==n.STATE.LOADED){var t=c.scale*(e.deltaY>0?.9:1/.9),a=e.clientX,i=e.clientY,s=t-c.scale,o=c.x+a*s,l=c.y+i*s;_(o,l,t)}e.preventDefault(),e.stopPropagation()}),r.state.show=1,i}},{key:"load",value:function(e){var t=this,i=t.__;if(a.isFile(e))n.getFileUrl(e,function(e,a){e?t._trigger(e,n.ERROR.OPEN_FILE_FAIL):a&&t.load(a)});else{a.isImg(e)&&(e=e.src);var r=function(e){n.loadImgToCanvas(i.canvas,e),i.width=e.width,i.height=e.height,t._trigger("load")};if(e&&a.isString(e)){t._trigger("loading");var s=new Image;s.crossOrigin="anonymous",s.onload=function(){r(s)},s.onerror=s.onabort=function(){t._trigger("error",{code:n.ERROR.LOAD_IMG_FAIL})},/^(?:blob|data):/i.test(e)||((e=e.split("#"))[0]=(e[0]+"&_random="+i.random).replace(/[?&]/,"?"),e=e.join("#")),s.src=e}else a.isCanvas(e)&&r(e)}return t}},{key:"save",value:function(e,t,i){var r=this,s=r.__,o=s.opts,l=s.view,c=s.transform;a.isFunction(e)?(i=e,e=t=null):a.isFunction(e)&&(i=t,t=null),null==e&&(e=o.type),null==t&&(t=o.quality);var h,u;try{var p=c.scale,d=parseInt((l.right-l.left)/p),f=parseInt((l.bottom-l.top)/p),v=parseInt(c.x+l.left/p),g=parseInt(c.y+l.top/p),_=n.createCanvas(d,f),y=_.getContext("2d");if(o.background&&(y.fillStyle=o.background,y.fillRect(0,0,d,f)),o.shape==n.SHAPE.CIRCLE&&(r._setClipShapePath(_),y.clip()),y.drawImage(s.canvas,v,g,d,f,0,0,d,f),o.width>0||o.height>0){var w=o.width,m=o.height;w>0?m>0||(m=w*f/d):w=m*d/f,d=w,f=m;var b=n.createCanvas(d,f);(y=b.getContext("2d")).drawImage(_,0,0,_.width,_.height,0,0,d,f),_=b}u={type:e,quality:t,data:_.toDataURL(e,t),width:d,height:f},a.extend(s.result,u)}catch(e){h={code:n.ERROR.LOAD_IMG_FAIL,error:e}}return h?r._trigger("error",h):(r._trigger("save",u),r.hide("save")),a.isFunction(i)&&i(h,u),r}},{key:"show",value:function(){var e=this,a=e.__;a.opts;return a.state.show&&(t.body.removeChild(a.iframe),a.state.show=0),e._initDlg().reset()._trigger("show"),e}},{key:"hide",value:function(e){var a=this,n=a.__;return n.state.show&&(t.body.removeChild(n.iframe),n.state.show=0),a._trigger("hide",e||"hide"),a}},{key:"reset",value:function(){var e=this,t=e.__,i=t.view,r=t.transform;if(t.state.show&&t.state.load==n.STATE.LOADED){var s=i.canvas,o=s.getContext("2d");s.width=t.width,s.height=t.height,o.clearRect(0,0,t.width,t.height),o.drawImage(t.canvas,0,0);var l=1,c=0,h=0,u=i.width/t.width,p=i.height/t.height;u>p?(l=u,h=parseInt((t.height-i.height/l)/2)):(l=p,c=parseInt((t.width-i.width/l)/2)),r.x=c,r.y=h,r.scale=l,a.transform(s,c,h,l)}return e}},{key:"clear",value:function(){return this._initData(this.__.opts)}},{key:"result",get:function(){return a.extend({},this.__.result)}},{key:"width",get:function(){return this.__.opts.width},set:function(e){e>0&&(this.__.opts.width=e)}},{key:"height",get:function(){return this.__.opts.height},set:function(e){e>0&&(this.__.opts.height=e)}}]),n}();e.CLIP=n}(window,document),function(e){e.ERROR={LOAD_IMG_FAIL:1,SAVE_IMG_FAIL:2,OPEN_FILE_FAIL:3},e.STATE={LOADING:1,LOADED:2},e.SHAPE={CIRCLE:"circle",SQUARE:"square",RECT:"rect"},e.TYPE={JPG:"image/jpeg",PNG:"image/png"},e.defaultOptions={background:null,shape:e.SHAPE.SQUARE,type:e.TYPE.PNG,rectRatio:1,quality:"",width:null,height:null}}(window.CLIP);