"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,a,n){return a&&t(e.prototype,a),n&&t(e,n),e}}();!function(t,e){var a=(e.body,{$:function(t,a,n){var i=n||"querySelector";return a&&a[i]?a[i](t):e[i](t)},$$:function(t,e){return this.$(t,e,"querySelectorAll")},transform:function(t,e,a,n){e=parseInt(e),a=parseInt(a),t.style.transformOrigin=t.style.webkitTransformOrigin=e+"px "+a+"px",t.style.transform=t.style.webkitTransform="translate("+-e+"px,"+-a+"px) scale("+n+")"},ontap:function(t,e){var a=null,n=null,i=null,r=null;t.addEventListener("touchstart",function(t){1==t.touches.length&&(a=i=t.touches[0].pageX,n=r=t.touches[0].pageY)}),t.addEventListener("touchmove",function(t){null!=a&&(i=t.touches[0].pageX,r=t.touches[0].pageY)}),t.addEventListener("touchend",function(){Math.pow(a-i,2)+Math.pow(n-r,2)<400&&e.call(t),a=null})},extend:function(){var t,e,n,i,r,s,o=arguments,l=o[0]||{},c=1,h=o.length,u=!1;for(a.isBoolean(l)&&(u=l,l=o[c]||{},c++),a.isObject(l)||a.isFunction(l)||(l={}),c===h&&(l=this,c--);c<h;c++)if(null!=(t=o[c]))for(e in t)n=l[e],i=t[e],l!==i&&(u&&i&&(jQuery.isPlainObject(i)||(r=Array.isArray(i)))?(r?(r=!1,s=n&&Array.isArray(n)?n:[]):s=n&&jQuery.isPlainObject(n)?n:{},l[e]=jQuery.extend(u,s,i)):void 0!==i&&(l[e]=i));return l}});Array.prototype.forEach.call(["Object","Function","String","Number","Array","Boolean","File",{type:"Img",key:"HTMLImageElement"},{type:"Canvas",key:"HTMLCanvasElement"}],function(t){a["is"+(t.type||t)]=function(e){return Object.prototype.toString.call(e)==="[object "+(t.key||t)+"]"}}),a.isTrueEmpty=function(t){return void 0===t||null===t||""===t||a.isNumber(t)&&isNaN(t)},a.isEmpty=function(t){if(a.isTrueEmpty(t))return!0;if(a.isObject(t)){for(var e in t)return!e&&!0;return!0}return a.isArray(t)?0===t.length:a.isString(t)?0===t.length:a.isNumber(t)?0===t:!!a.isBoolean(t)&&!t};var n=function(){function n(t){_classCallCheck(this,n),this._initData(t)}return _createClass(n,null,[{key:"createCanvas",value:function(t,a){var n=e.createElement("canvas");return t>0&&(n.width=t),a>0&&(n.height=a),n}},{key:"loadImgToCanvas",value:function(t,e){var a=t.getContext("2d"),n=t.width=e.width,i=t.height=e.height;a.clearRect(0,0,n,i),a.drawImage(e,0,0)}},{key:"getFileUrl",value:function(e,n){if(a.isFunction(n))if(a.isFile(e)){var i;if(t.URL)try{i=URL.createObjectURL(e)}catch(r){}if(i)n(null,i);else try{var s=new FileReader;s.onload=function(){n(null,this.result)},s.onerror=n,s.readAsDataURL(e)}catch(r){n(r)}}else n()}}]),_createClass(n,[{key:"__loadingHandler",value:function(){var t=this,e=t.__;e.state.load=n.STATE.LOADING,t._showLayer("loading")}},{key:"__loadHandler",value:function(){var t=this,e=t.__;if(e.state.load=n.STATE.LOADED,t.reset(),e.state.show){var i=e.iframe.contentDocument;a.$(".js_clip_save",i).className="js_clip_save",t._hideLayer()}}},{key:"__showHandler",value:function(){var t=this,e=t.__;e.state.load==n.STATE.LOADING?t._showLayer("loading"):e.state.load!=n.STATE.LOADED&&t._showLayer("empty")}},{key:"__hideHandler",value:function(){}},{key:"__saveHandler",value:function(){}},{key:"__errorHandler",value:function(t){var e=this,a=e.__;if(!t.message)switch(t.code){case n.ERROR.LOAD_IMG_FAIL:t.message="加载图片失败";break;case n.ERROR.SAVE_IMG_FAIL:t.message="保存图片失败";break;case n.ERROR.OPEN_FILE_FAIL:t.message="读取文件失败"}a.state.error=t,e._showLayer("error",t)}},{key:"_trigger",value:function(t,e){var n=this;if(t&&a.isString(t)){var i=n["__"+t+"Handler"];i&&i.call(n,e),i=n.__.opts["on"+t.toLowerCase()],a.isFunction(i)&&i.call(n,e)}return n}},{key:"_showLayer",value:function(t,e){var n=this,i=n.__;if(i.state.show){var r,s=i.iframe.contentDocument;switch(t){case"loading":r="loading",e="正在加载中";break;case"error":r="error",e=e&&e.message||"操作失败";break;case"empty":r="file",e="选择文件"}if(r){e||(e="");var o=a.$(".js_layer",s);o.innerHTML='<div class="laver-wrap"><svg class="clip-icon"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon_'+r+'"></use></svg><span>'+e+"</span></div>",o.setAttribute("data-type",t),o.style.display=""}}return n}},{key:"_hideLayer",value:function(){var t=this,e=t.__;if(e.state.show){var n=e.iframe.contentDocument;a.$(".js_layer",n).style.display="none"}return t}},{key:"_setClipShapePath",value:function(t,e){var a=this,i=a.__,r=i.opts,s=i.view,o=t.width,l=t.height,c=t.getContext("2d"),h=Math.min(o,l),u=Math.max(0,parseInt((o-h)/2)),d=Math.max(0,parseInt((l-h)/2));return e&&(s.size=h,s.left=u,s.top=d,s.right=u+h,s.bottom=d+h),e&&(c.save(),c.clearRect(0,0,o,l),c.fillStyle="rgba(0,0,0,.7)",c.fillRect(0,0,o,l)),c.beginPath(),r.shape==n.SHAPE.CIRCLE?c.arc(parseInt(o/2),parseInt(l/2),parseInt(h/2),0,2*Math.PI):c.rect(u,d,h,h),c.closePath(),e&&(c.clip(),c.clearRect(0,0,o,l),c.strokeStyle="#fff",c.stroke(),c.restore()),a}},{key:"_initData",value:function(t){var e=this,i=0;e.__&&e.__.state&&e.__.state.show&&(i=1,e.hide());var r={opts:{},state:{error:0,load:0,show:0},canvas:n.createCanvas(),iframe:null,content:"",width:0,height:0,view:{canvas:n.createCanvas(),width:0,height:0,size:0,btnsHeight:54,left:0,right:0,top:0,bottom:0},transform:{x:0,y:0,scale:1},random:parseInt(1e5*Math.random()),result:{type:"",quality:null,data:"",width:0,height:0}};e.__=r;for(var s in n.defaultOptions)r.opts[s]=n.defaultOptions[s];if(a.isObject(t))for(var s in t)/^on\w/.test(s)&&a.isFunction(t[s])?r.opts[s.toLowerCase()]=t[s]:r.opts[s]=t[s];return i&&e.show(),e}},{key:"_initDlg",value:function(){var i=this,r=i.__,s=(r.opts,r.view),o=r.iframe,l=r.content,c=r.transform;o||(o=e.createElement("iframe"),o.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;border:0",l="<style>\n                    body{margin:0;font:16px/1.5 sans-serif}\n                    a,a:hover{text-decoration:none}\n                    .clip,.layer{display:-webkit-box;display:flex;position:fixed;top:0;left:0;right:0;bottom:0;background-color:#000;}\n                    .clip{-webkit-box-orient:vertical;flex-direction:column}\n                    .clip-cont{position:relative;-webkit-box-flex:1;flex:1;overflow:hidden}\n                    .clip-cont>*{position:absolute;left:0;top:0;}\n                    .clip-btns{display:-webkit-box;display:flex;width:100%;height:"+s.btnsHeight+'px;background:rgba(255,255,255,.1)}\n                    .clip-btns>*{display:block;padding:15px 0;width:50%;font-size:16px;color:#fff;text-align:center}\n                    .clip-btns>*:first-child{opacity:.7}\n                    .clip-icon{display:inline-block;width:32px;height:32px;fill:#fff;}\n                    .layer{-webkit-box-pack:center;-webkit-box-align:center;align-items:center;background:rgba(0,0,0,.5);color:#fff;line-height:50px;}\n                    .laver-wrap{width:100%;text-align:center}\n                    .laver-wrap>*{vertical-align:middle;}\n                    .laver-wrap svg{margin-right:5px;}\n                    .disable{opacity:.4}\n                    </style>\n                    <svg style="display:none;" xmlns="http://www.w3.org/2000/svg">\n                        <defs>\n                            <symbol id="icon_loading" viewBox="0 0 50 50">\n                                <path d="M43.935,25.145c0-10.318-8.364-18.683-18.683-18.683c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615c8.072,0,14.615,6.543,14.615,14.615H43.935z">\n                                    <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"/>\n                                </path>\n                            </symbol>\n                            <symbol id="icon_error" viewBox="0 0 32 32">\n                                <path d="M18.086 20.232c0.083 0.090 0.133 0.21 0.133 0.342 0 0.279-0.226 0.505-0.505 0.505-0.154 0-0.292-0.069-0.385-0.177l-0.001 0.001c-0.003-0.004-0.006-0.008-0.009-0.013-0.007-0.009-0.014-0.018-0.021-0.028-0.52-0.688-1.346-1.132-2.275-1.132-0.898 0-1.699 0.415-2.222 1.064-0.085 0.165-0.257 0.278-0.455 0.278-0.283 0-0.511-0.229-0.511-0.512 0-0.144 0.059-0.273 0.155-0.366 0.697-0.913 1.796-1.503 3.034-1.503 1.254 0 2.367 0.606 3.062 1.541zM17.2 25.72v0h8.52c0.414 0 0.748-0.335 0.748-0.747v-17.945c0-0.414-0.335-0.747-0.748-0.747h-21.382c-0.414 0-0.748 0.335-0.748 0.747v17.945c0 0.414 0.335 0.747 0.748 0.747h8.376l1.199 1.046 1.030 0h-1.029l1.2 1.047 1.117-1.047-0.96-0h0.961l1.116-1.046h-0.146zM17.495 26.766l-1.944 1.833c-0.24 0.227-0.635 0.234-0.884 0.016l-2.104-1.848h-8.524c-0.827 0-1.497-0.668-1.497-1.495v-18.543c0-0.826 0.67-1.495 1.497-1.495h21.979c0.827 0 1.497 0.668 1.497 1.495v18.543c0 0.826-0.67 1.495-1.497 1.495h-8.522zM27.514 24.822v-1.047h0.149c0.414 0 0.748-0.335 0.748-0.747v-17.945c0-0.414-0.335-0.747-0.748-0.747h-21.382c-0.414 0-0.748 0.335-0.748 0.747v0.15h-1.047v-0.449c0-0.826 0.67-1.495 1.497-1.495h21.979c0.827 0 1.497 0.668 1.497 1.495v18.543c0 0.826-0.67 1.495-1.497 1.495h-0.447zM21.533 11.364l0.748 0.73-1.794 1.991 1.794 1.938-0.748 0.724-2.393-2.672 2.393-2.712zM8.374 11.364l2.393 2.712-2.393 2.672-0.748-0.724 1.794-1.938-1.794-1.991 0.748-0.73z"></path>\n                            </symbol>\n                            <symbol id="icon_file" viewBox="0 0 15 15">\n                                <path d="M14.969,0.031 L5,0.031 L5,2.969 L6,2.969 L6,1 L14.027,1 L14.027,8.001 L11,8.001 L11,10.952 L14.969,10.952 L14.969,0.031 Z" class="si-glyph-fill"></path>\n                                <path d="M0,4 L0,15 L10,15 L10,4 L0,4 L0,4 Z M8.967,12 L0.967,12 L0.967,5 L8.967,5 L8.967,12 L8.967,12 Z" class="si-glyph-fill"></path>\n                            </symbol>\n                        </defs>\n                    </svg>\n                    <div class="clip js_clip">\n                        <div class="clip-cont">\n                            <div class="js_clip_pic"></div>\n                            <canvas class="clip-cover js_clip_cover"></canvas>\n                            <div class="layer js_layer" style="display:none"></div>\n                        </div>\n                        <div class="clip-btns">\n                            <a class="js_clip_cancel" href="javascript:;">取消</a>\n                            <a class="js_clip_save disable" href="javascript:;">选取</a>\n                        </div>\n                    </div>',r.iframe=o,r.content=l),e.body.appendChild(o);var h=o.contentDocument;h.write(l),h.close();var u=parseInt(t.innerWidth),d=parseInt(t.innerHeight-s.btnsHeight);s.width=u,s.height=d;var p=a.$(".js_clip_cover",h);p.width=u,p.height=d,i._setClipShapePath(p,!0);var f=s.canvas;a.$(".js_clip_pic",h).appendChild(f);var v,g=0,y=function(t,e,n){var i=r.width,o=r.height,l=s.left/n,h=s.top/n,u=s.right/n,d=s.bottom/n;t=Math.min(Math.max(t,-l),i-u),e=Math.min(Math.max(e,-h),o-d),t>=-l&&t<=i-u&&e>=-h&&e<=o-d&&(c.x=t,c.y=e,c.scale=n,a.transform(f,t,e,n))};return p.addEventListener("touchstart",function(t){if(r.state.show&&r.state.load==n.STATE.LOADED){g=1,v=[];for(var e=0,a=t.touches.length;e<a;e++)v.push({x:t.touches[e].pageX,y:t.touches[e].pageY})}t.preventDefault(),t.stopPropagation()}),p.addEventListener("touchmove",function(t){if(g){var e,a,n,i,o=(r.width,r.height,s.size,c.scale),l=t.touches[0].pageX,h=t.touches[0].pageY;if(2==t.touches.length&&2==v.length){n=t.touches[1].pageX,i=t.touches[1].pageY;var u=(v[0].x+v[1].x)/2,d=(v[0].y+v[1].y)/2,p=Math.sqrt(Math.pow(v[1].x-v[0].x,2)+Math.pow(v[1].y-v[0].y,2)),f=Math.sqrt(Math.pow(n-l,2)+Math.pow(i-h,2)),_=f/p;o=c.scale*_;var w=(_-1)/o;e=c.x+u*w,a=c.y+d*w}else e=c.x+(v[0].x-l)/o,a=c.y+(v[0].y-h)/o;y(e,a,o),v[0].x=l,v[0].y=h,2==v.length&&(v[1].x=n,v[1].y=i)}t.preventDefault(),t.stopPropagation()}),p.addEventListener("touchend",function(){g=0}),p.addEventListener("touchcancel",function(){g=0}),p.addEventListener("mousewheel",function(t){if(r.state.show&&r.state.load==n.STATE.LOADED){var e=c.scale*(t.deltaY>0?.9:1/.9),a=t.clientX,i=t.clientY,s=e-c.scale,o=c.x+a*s,l=c.y+i*s;y(o,l,e)}t.preventDefault(),t.stopPropagation()}),a.ontap(a.$(".js_clip_cancel",h),function(){i.hide("cancel")}),a.ontap(a.$(".js_clip_save",h),function(){/disable/.test(this.className)||i.save()}),a.ontap(a.$(".js_layer",h),function(){if("empty"==this.getAttribute("data-type")){var t=a.$("#file",h);t||(t=h.createElement("input"),t.id="file",t.type="file",t.style.display="none",t.accept="image/*",h.body.appendChild(t),t.onchange=function(){this.files[0]&&i.load(this.files[0])}),t.click()}}),r.state.show=1,i}},{key:"load",value:function(t){var e=this,i=e.__;if(a.isFile(t))n.getFileUrl(t,function(t,a){t?e._trigger(t,n.ERROR.OPEN_FILE_FAIL):a&&e.load(a)});else{a.isImg(t)&&(t=t.src);var r=function(t){n.loadImgToCanvas(i.canvas,t),i.width=t.width,i.height=t.height,e._trigger("load")};if(t&&a.isString(t)){e._trigger("loading");var s=new Image;s.crossOrigin="anonymous",s.onload=function(){r(s)},s.onerror=s.onabort=function(){e._trigger("error",{code:n.ERROR.LOAD_IMG_FAIL})},/^(?:blob|data):/i.test(t)||(t=t.split("#"),t[0]=(t[0]+"&_random="+i.random).replace(/[?&]/,"?"),t=t.join("#")),s.src=t}else a.isCanvas(t)&&r(t)}return e}},{key:"save",value:function(t,e,i){var r=this,s=r.__,o=s.opts,l=s.view,c=s.transform;a.isFunction(t)?(i=t,t=e=null):a.isFunction(t)&&(i=e,e=null),null==t&&(t=o.type),null==e&&(e=o.quality);var h,u;try{var d=c.scale,p=parseInt((l.right-l.left)/d),f=parseInt((l.bottom-l.top)/d),v=parseInt(c.x+l.left/d),g=parseInt(c.y+l.top/d),y=n.createCanvas(p,f),_=y.getContext("2d");if(o.background&&(_.fillStyle=o.background,_.fillRect(0,0,p,f)),r._setClipShapePath(y),_.clip(),_.drawImage(s.canvas,v,g,p,f,0,0,p,f),o.width>0||o.height>0){var w=o.width,m=o.height;w>0?m>0||(m=w*f/p):w=m*p/f,p=w,f=m;var b=n.createCanvas(p,f);_=b.getContext("2d"),_.drawImage(y,0,0,y.width,y.height,0,0,p,f),y=b}u={type:t,quality:e,data:y.toDataURL(t,e),width:p,height:f},a.extend(s.result,u)}catch(L){h={code:n.ERROR.LOAD_IMG_FAIL,error:L}}return h?r._trigger("error",h):(r._trigger("save",u),r.hide("save")),a.isFunction(i)&&i(h,u),r}},{key:"show",value:function(){var t=this,a=t.__;a.opts;return a.state.show&&(e.body.removeChild(a.iframe),a.state.show=0),t._initDlg().reset()._trigger("show"),t}},{key:"hide",value:function(t){var a=this,n=a.__;return n.state.show&&(e.body.removeChild(n.iframe),n.state.show=0),a._trigger("hide",t||"hide"),a}},{key:"reset",value:function(){var t=this,e=t.__,i=e.view,r=e.transform;if(e.state.show&&e.state.load==n.STATE.LOADED){var s=i.canvas,o=s.getContext("2d");s.width=e.width,s.height=e.height,o.clearRect(0,0,e.width,e.height),o.drawImage(e.canvas,0,0);var l=1,c=0,h=0,u=i.width/e.width,d=i.height/e.height;u>d?(l=u,h=parseInt((e.height-i.height/l)/2)):(l=d,c=parseInt((e.width-i.width/l)/2)),r.x=c,r.y=h,r.scale=l,a.transform(s,c,h,l)}return t}},{key:"clear",value:function(){return this._initData(this.__.opts)}},{key:"result",get:function(){return a.extend({},this.__.result)}},{key:"width",get:function(){return this.__.opts.width},set:function(t){t>0&&(this.__.opts.width=t)}},{key:"height",get:function(){return this.__.opts.height},set:function(t){t>0&&(this.__.opts.height=t)}}]),n}();t.CLIP=n}(window,document),function(t){t.ERROR={LOAD_IMG_FAIL:1,SAVE_IMG_FAIL:2,OPEN_FILE_FAIL:3},t.STATE={LOADING:1,LOADED:2},t.SHAPE={CIRCLE:"circle",SQUARE:"square"},t.TYPE={JPG:"image/jpeg",PNG:"image/png"},t.defaultOptions={background:null,shape:t.SHAPE.SQUARE,type:t.TYPE.PNG,quality:"",width:null,height:null}}(window.CLIP);